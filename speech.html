<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>í•œêµ­ì–´ ë°œìŒ êµì • ì•± - Web Speech API</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; max-width: 800px; margin: 0 auto; }
    h1 { color: #333; }
    .result-container { margin-top: 1.5rem; }
    .result-box {
      margin-top: 0.5rem;
      padding: 1rem;
      border-radius: 5px;
      font-size: 1.2rem;
    }
    .original {
      color: #e74c3c;
      border: 1px solid #e74c3c;
      background-color: #fef2f0;
    }
    .corrected {
      color: #2ecc71;
      border: 1px solid #2ecc71;
      background-color: #f0faf4;
      display: none;
    }
    .result-label {
      font-weight: bold;
      margin-bottom: 0.3rem;
      display: block;
    }
    button {
      margin-right: 1rem;
      padding: 0.5rem 1rem;
      font-size: 1rem;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:disabled { background-color: #cccccc; cursor: not-allowed; }
    button#stop { background-color: #f44336; }
    .status { margin-top: 1rem; font-style: italic; color: #666; }
    .hidden { display: none; }
    .loading { display: inline-block; width: 1rem; height: 1rem; border: 2px solid rgba(0, 0, 0, 0.1); border-radius: 50%; border-top-color: #007bff; animation: spin 1s ease-in-out infinite; margin-left: 0.5rem; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .audio-visualizer { margin-top: 1rem; height: 60px; width: 100%; background: #f0f0f0; border-radius: 5px; }
    .debug-info { 
      margin-top: 1rem; 
      padding: 1rem; 
      border: 1px solid #ccc; 
      border-radius: 5px; 
      background-color: #f9f9f9; 
      font-family: monospace; 
      max-height: 200px; 
      overflow-y: auto; 
      font-size: 0.9rem;
      white-space: pre-wrap;
      display: block;
    }
    .pronunciation-input {
      width: 100%;
      padding: 0.5rem;
      margin-top: 1rem;
      font-size: 1.2rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #manual-input-container {
      margin-top: 1.5rem;
      padding: 1rem;
      border: 1px solid #3498db;
      border-radius: 5px;
      background-color: #ebf5fb;
    }
    .tab-container {
      display: flex;
      margin-top: 1.5rem;
    }
    .tab {
      padding: 0.5rem 1rem;
      cursor: pointer;
      border: 1px solid #ccc;
      border-bottom: none;
      border-radius: 5px 5px 0 0;
      background-color: #f5f5f5;
    }
    .tab.active {
      background-color: white;
      border-bottom: 1px solid white;
      margin-bottom: -1px;
      font-weight: bold;
    }
    .tab-content {
      display: none;
      padding: 1rem;
      border: 1px solid #ccc;
      border-radius: 0 5px 5px 5px;
    }
    .tab-content.active {
      display: block;
    }
  </style>
</head>
<body>
  <h1>ğŸ¤ í•œêµ­ì–´ ë°œìŒ êµì •</h1>
  
  <div class="tab-container">
    <div class="tab active" data-tab="voice">ìŒì„± ì…ë ¥</div>
    <div class="tab" data-tab="manual">ì§ì ‘ ì…ë ¥</div>
  </div>
  
  <div id="voice-tab" class="tab-content active">
    <button id="start">ë…¹ìŒ ì‹œì‘</button>
    <button id="stop" disabled>ğŸ›‘ ë…¹ìŒ ì¤‘ì§€</button>
    <div class="status" id="status">ì‹œì‘í•˜ë ¤ë©´ ë…¹ìŒ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
  </div>
  
  <div id="manual-tab" class="tab-content">
    <div id="manual-input-container">
      <p>ë°œìŒ ì†Œë¦¬ë¥¼ ê·¸ëŒ€ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”:</p>
      <input type="text" id="pronunciation-input" class="pronunciation-input" placeholder="ì˜ˆ: 'í•¨ë²„ê°€ ë¨¹ê³  ì‹œë”°'">
      <button id="submit-pronunciation">êµì • ìš”ì²­</button>
    </div>
  </div>
  
  <div class="result-container">
    <div class="result-box original" id="original">
      <span class="result-label">ğŸ§ ì‹¤ì œ ë°œìŒ:</span>
      <div id="transcript">ê²°ê³¼ ëŒ€ê¸° ì¤‘...</div>
    </div>
    
    <div class="result-box corrected" id="corrected-container">
      <span class="result-label"> êµì •ëœ ë¬¸ì¥:</span>
      <div id="corrected">êµì • ëŒ€ê¸° ì¤‘...</div>
    </div>
  </div>
  
  <div class="debug-info" id="debug-info"></div>

  <script>
    // ì „ì—­ ë³€ìˆ˜
    let recognition;
    let recordedChunks = [];
    let mediaRecorder;
    let rawTranscript = "";
    let gumStream;
    
    // DOM ìš”ì†Œ
    const statusElement = document.getElementById("status");
    const transcriptElement = document.getElementById("transcript");
    const correctedElement = document.getElementById("corrected");
    const correctedContainer = document.getElementById("corrected-container");
    const startButton = document.getElementById("start");
    const stopButton = document.getElementById("stop");
    const debugInfoElement = document.getElementById("debug-info");
    const pronunciationInput = document.getElementById("pronunciation-input");
    const submitPronunciationButton = document.getElementById("submit-pronunciation");
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    
    // íƒ­ ì „í™˜ ê¸°ëŠ¥
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const tabId = tab.getAttribute('data-tab');
        
        // ëª¨ë“  íƒ­ê³¼ ì»¨í…ì¸ ë¥¼ ë¹„í™œì„±í™”
        tabs.forEach(t => t.classList.remove('active'));
        tabContents.forEach(c => c.classList.remove('active'));
        
        // ì„ íƒí•œ íƒ­ê³¼ ì»¨í…ì¸ ë¥¼ í™œì„±í™”
        tab.classList.add('active');
        document.getElementById(`${tabId}-tab`).classList.add('active');
      });
    });
    
    // ë””ë²„ê·¸ ë¡œê·¸ í•¨ìˆ˜
    function logDebug(message) {
      console.log(message);
      debugInfoElement.style.display = "block";
      debugInfoElement.textContent += message + "\n";
      debugInfoElement.scrollTop = debugInfoElement.scrollHeight;
    }
    
    // Web Speech API ì§€ì› í™•ì¸
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
      logDebug("ì´ ë¸Œë¼ìš°ì €ëŠ” Web Speech APIë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
      alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. Chrome ë¸Œë¼ìš°ì €ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.");
      startButton.disabled = true;
    }
    
    // ë…¹ìŒ ì‹œì‘
    async function startRecording() {
      try {
        // Web Speech API ì´ˆê¸°í™”
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.lang = 'ko-KR';  // í•œêµ­ì–´ ì¸ì‹
        recognition.continuous = true;  // ì—°ì† ì¸ì‹
        recognition.interimResults = true;  // ì¤‘ê°„ ê²°ê³¼ í‘œì‹œ (ë¯¸ì™„ì„± ë°œí™”ë„ ë³´ì—¬ì¤Œ)
        
        // ë§ˆì´í¬ ì ‘ê·¼ (ì˜¤ë””ì˜¤ íŒŒì¼ ì €ì¥ìš©)
        logDebug("ë§ˆì´í¬ ì•¡ì„¸ìŠ¤ ìš”ì²­ ì¤‘...");
        gumStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        // ë…¹ìŒ ì„¤ì •
        recordedChunks = [];
        mediaRecorder = new MediaRecorder(gumStream);
        
        mediaRecorder.ondataavailable = (e) => {
          if (e.data.size > 0) recordedChunks.push(e.data);
        };
        
        // ë…¹ìŒ ì‹œì‘
        mediaRecorder.start(1000);
        logDebug("ë…¹ìŒ ì‹œì‘ë¨");
        
        // Web Speech ê²°ê³¼ ì²˜ë¦¬
        rawTranscript = "";
        
        recognition.onresult = (event) => {
          let interimTranscript = '';
          let finalTranscript = '';
          
          // ê²°ê³¼ ì²˜ë¦¬
          for (let i = event.resultIndex; i < event.results.length; i++) {
            const transcript = event.results[i][0].transcript;
            
            if (event.results[i].isFinal) {
              finalTranscript += transcript;
              rawTranscript += transcript + " ";
            } else {
              interimTranscript += transcript;
            }
          }
          
          // ê²°ê³¼ í‘œì‹œ (ì›ì‹œ ë°œìŒ ê·¸ëŒ€ë¡œ)
          transcriptElement.innerText = rawTranscript + interimTranscript;
        };
        
        recognition.onerror = (event) => {
          logDebug("ì¸ì‹ ì˜¤ë¥˜: " + event.error);
        };
        
        // Web Speech API ì‹œì‘
        recognition.start();
        
        // UI ì—…ë°ì´íŠ¸
        startButton.disabled = true;
        stopButton.disabled = false;
        transcriptElement.innerText = "ë§ì”€í•´ì£¼ì„¸ìš”...";
        correctedElement.innerText = "êµì • ëŒ€ê¸° ì¤‘...";
        correctedContainer.style.display = "none";
        statusElement.innerHTML = "ë…¹ìŒ ì¤‘... <span class='loading'></span>";
        
      } catch (error) {
        console.error("ë…¹ìŒ ì‹œì‘ ì˜¤ë¥˜:", error);
        logDebug("ë…¹ìŒ ì‹œì‘ ì˜¤ë¥˜: " + error.message);
        statusElement.innerText = "ë§ˆì´í¬ ì ‘ê·¼ ì˜¤ë¥˜: " + error.message;
      }
    }
    
    // ë…¹ìŒ ì¢…ë£Œ
    function stopRecording() {
      // Web Speech API ì¤‘ì§€
      if (recognition) {
        recognition.stop();
        logDebug("ìŒì„± ì¸ì‹ ì¤‘ì§€ë¨");
      }
      
      // ë…¹ìŒ ì¢…ë£Œ
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        logDebug("ë…¹ìŒ ì¢…ë£Œë¨");
      }
      
      // ì˜¤ë””ì˜¤ íŠ¸ë™ ì¢…ë£Œ
      if (gumStream) {
        gumStream.getTracks().forEach(track => track.stop());
      }
      
      // UI ì—…ë°ì´íŠ¸
      startButton.disabled = false;
      stopButton.disabled = true;
      statusElement.innerHTML = "ì²˜ë¦¬ ì¤‘... <span class='loading'></span>";
    }
    
    // ì„œë²„ì— êµì • ìš”ì²­ ë³´ë‚´ê¸°
    async function requestCorrection(text, audioBlob = null) {
      try {
        const formData = new FormData();
        
        if (audioBlob) {
          formData.append("audio", audioBlob, "recording.webm");
        } else {
          // ì˜¤ë””ì˜¤ ì—†ì´ í…ìŠ¤íŠ¸ë§Œ ë³´ë‚¼ ê²½ìš° ë¹ˆ íŒŒì¼ ì¶”ê°€ (ì„œë²„ì—ì„œ ì˜¤ë””ì˜¤ íŒŒì¼ ì²´í¬í•˜ë¯€ë¡œ)
          const emptyBlob = new Blob([''], { type: 'audio/webm' });
          formData.append("audio", emptyBlob, "empty.webm");
        }
        
        formData.append("transcript", text);
        
        logDebug("ì„œë²„ API í˜¸ì¶œ ì¤‘...");
        statusElement.innerHTML = "êµì • ì²˜ë¦¬ ì¤‘... <span class='loading'></span>";
        
        const uploadResponse = await fetch("/upload", {
          method: "POST",
          body: formData
        });
        
        if (!uploadResponse.ok) {
          const errorText = await uploadResponse.text();
          logDebug(`êµì • ì˜¤ë¥˜ ì‘ë‹µ: ${uploadResponse.status} - ${errorText}`);
          throw new Error(`êµì • ì˜¤ë¥˜: ${uploadResponse.status}`);
        }
        
        const result = await uploadResponse.json();
        logDebug("êµì • ê²°ê³¼ ìˆ˜ì‹ : " + JSON.stringify(result));
        
        // ê²°ê³¼ í‘œì‹œ - ì›ë³¸ ë°œìŒê³¼ êµì •ëœ ë¬¸ì¥ ëª¨ë‘ í‘œì‹œ
        if (result.raw_transcript) {
          transcriptElement.innerText = result.raw_transcript;
        }
        
        correctedElement.innerText = result.answer;
        correctedContainer.style.display = "block";
        statusElement.innerText = "êµì • ì™„ë£Œ!";
        
      } catch (error) {
        console.error("ì²˜ë¦¬ ì˜¤ë¥˜:", error);
        logDebug("ì²˜ë¦¬ ì˜¤ë¥˜: " + error.message);
        statusElement.innerText = "ì˜¤ë¥˜ ë°œìƒ: " + error.message;
      }
    }
    
    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    document.addEventListener("DOMContentLoaded", () => {
      // ë…¹ìŒ ì‹œì‘ ë²„íŠ¼
      startButton.onclick = startRecording;
      
      // ë…¹ìŒ ì¢…ë£Œ ë²„íŠ¼
      stopButton.onclick = () => {
        stopRecording();
        
        // ì„œë²„ì— ë…¹ìŒ ë°ì´í„° ì „ì†¡
        mediaRecorder.onstop = async () => {
          // ë…¹ìŒëœ ë°ì´í„°ë¥¼ Blobìœ¼ë¡œ ë³€í™˜
          const audioBlob = new Blob(recordedChunks, { type: 'audio/webm' });
          logDebug(`ì˜¤ë””ì˜¤ ë¸”ë¡­ ìƒì„±: ${Math.round(audioBlob.size / 1024)} KB`);
          
          // êµì • ìš”ì²­
          await requestCorrection(rawTranscript, audioBlob);
        };
      };
      
      // ì§ì ‘ ì…ë ¥ ì œì¶œ ë²„íŠ¼
      submitPronunciationButton.onclick = async () => {
        const text = pronunciationInput.value.trim();
        if (text) {
          transcriptElement.innerText = text;
          await requestCorrection(text);
        } else {
          alert("ë°œìŒì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        }
      };
      
      // ì—”í„°í‚¤ ì²˜ë¦¬
      pronunciationInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          submitPronunciationButton.click();
        }
      });
    });
  </script>
</body>
</html>